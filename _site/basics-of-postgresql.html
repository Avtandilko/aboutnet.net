<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-111661498-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'UA-111661498-1');
  </script>
  
  <!-- Yandex.Metrika counter -->
  <script type="text/javascript" >
      (function (d, w, c) {
          (w[c] = w[c] || []).push(function() {
              try {
                  w.yaCounter45675420 = new Ya.Metrika({
                      id:45675420,
                      clickmap:true,
                      trackLinks:true,
                      accurateTrackBounce:true
                  });
              } catch(e) { }
          });
  
          var n = d.getElementsByTagName("script")[0],
              s = d.createElement("script"),
              f = function () { n.parentNode.insertBefore(s, n); };
          s.type = "text/javascript";
          s.async = true;
          s.src = "https://mc.yandex.ru/metrika/watch.js";
  
          if (w.opera == "[object Opera]") {
              d.addEventListener("DOMContentLoaded", f, false);
          } else { f(); }
      })(document, window, "yandex_metrika_callbacks");
  </script>
  <noscript><div><img src="https://mc.yandex.ru/watch/45675420" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
  <!-- /Yandex.Metrika counter -->

  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Basics Of PostgreSQL &middot; AboutNet
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p></p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>
    <a class="sidebar-nav-item" href="/categories/">Categories</a> 
    <a class="sidebar-nav-item" href="/about/">About</a>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; <a href="https://jekyllrb.com/">Jekyll</a> & <a href="http://lanyon.getpoole.com/">Lanyon</a>. 2018. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <label for="sidebar-checkbox" class="sidebar-toggle"></label>

          <h3 class="masthead-title">
            <a href="/" title="Home">AboutNet</a>
            <small>all about networks</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Basics Of PostgreSQL</h1>
  <span class="post-date">16 Feb 2018</span>
    <p>Часть “Архитектура PostgreSQL” является конспектом <a href="https://www.youtube.com/playlist?list=PLaFqU3KCWw6KzGwUubZm-9-vKsi6vh5qC">лекций Postgres Professional</a>.</p>

<h1 id="архитектура-postgresql">Архитектура PostgreSQL</h1>

<p>Изначально при старте PostgreSQL запускается процесс postmaster. Он:</p>
<ol>
  <li>Создает структуры в памяти, которые будут использоваться другими процессами;</li>
  <li>Создает все остальные процессы (fork) и управляет ими (перезапуск и т.д.);</li>
  <li>Слушает входящие соединения и на каждого клиента создает отдельный серверный процесс postgres.</li>
</ol>

<!---excerpt-break-->

<h2 id="организация-данных">Организация данных</h2>
<p>Совокупность баз данных называется кластером.
С точки зрения физической организации, данные хранятся в табличных пространствах (каталогах в файловой системе).</p>

<h3 id="массив-буферов">Массив буферов</h3>
<p>Часто используемые страницы остаются в буферном кэше, редко используемые заменяются.
Страницы записываются на диск время от времени (процесс background writer). Иногда серверный процесс также может инициировать запись данных на диск.</p>

<h2 id="транзакции">Транзакции</h2>
<ol>
  <li>Атомарность - либо выполняются все изменения, либо ни одно из них;</li>
  <li>Согласованность (целостность данных) - система переходит из одного целостного состояния в другое;</li>
  <li>Изоляция - на результат не должны оказывать влияния другие транзакции. Postgres поддерживает 3 уровня изоляции из 4 (commit не поддерживается);</li>
  <li>Долговечность - зафиксированные изменения не теряются (подробнее в секции про WAL).</li>
</ol>

<h3 id="журнал-write-ahead-log">Журнал (Write Ahead Log)</h3>

<p>Общая идея - при выполнении любых изменений в журнал записывается информация, достаточная для повторения данных изменений. Данная информация должна попасть на диск раньше, чем запишутся сами изменения (процесс wal writer). 
При пропадании из буфера данных, которые не успели записаться на диск (перезагрузка и т.д.) они восстанавливаются из WAL. Информация записывается в файлы по 16 МБ по умолчанию (возможна архивация старых файлов процессом wal archiver). 
Возможна синхронная (надежно), либо асинхронная (быстро) запись.</p>

<p>Также используется процесс checkpointer для принудительного периодического сброса всей информации из буферов на диск. После прохождения контрольной точки журналы, которые были записаны до этого, теряют актуальность.</p>

<h2 id="многоверсионность-mvcc">Многоверсионность (MVCC)</h2>
<p>Каждая транзакция работает со снимком (snapshot).
На нижнем уровне, когда в таблицу вставляется/удаляется строка, в ней отмечается номер транзакции, которая создала/удалила данную строку.</p>

<p>Периодически (либо вручную) запускается процесс vacuum, который очищает версии строк, недоступные более ни в одном снимке.</p>

<h1 id="базовая-настройка-потоковой-репликации">Базовая настройка потоковой репликации</h1>
<p>Шпаргалка по мотивам <a href="https://eax.me/postgresql-replication/">https://eax.me/postgresql-replication/</a></p>

<p>Вкратце - потоковая репликация в PostgreSQL это передача WAL от мастера к репликам. Работает только в пределах одной архитектуры, а также одной версии PostgreSQL.</p>

<p>Настройка репликации от имени пользователя postgres (ограничения доступа по IP отсутствуют) производится следующим образом</p>

<h2 id="master">Master</h2>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pg_hba.conf
host    replication      postgres       0.0.0.0/0           md5
host    all              postgres       0.0.0.0/0           md5
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>postgresql.conf
listen_addresses = '*'
wal_level = hot_standby
wal_log_hints = on
max_wal_senders = 8
wal_keep_segments = 64
hot_standby = on
</code></pre></div></div>

<h2 id="slave">Slave</h2>

<p>Для выполнения следующего действия необходимо, чтобы директория с БД (в примере main) была пустой. Будет целесообразно сделать резервную копию предыдущего содержимого, либо параллельно изменить данную директорию в postgresql.conf (data_directory). Действие выполняется при остановленном процессе PostgreSQL.</p>

<p><code class="highlighter-rouge">pg_basebackup -P -R -X stream -c fast -h master_ip -U postgres -D ./main</code></p>

<p>После этого БД будет скопирована на slave, также будет создан файл recovery.conf, описывающий параметры репликации.</p>

<p>pg_hba.cong и postgresql.conf требуется отредактировать аналогично файлам на master.</p>

<p>Далее можно запустить PostgreSQL на slave и убедиться, что репликация запустилась, с использованием следующего запроса на master:</p>

<p><code class="highlighter-rouge">SELECT * FROM pg_stat_replication;</code></p>

<p>Следует отметить, что читать можно как с master, так и со slave (по крайней мере в данном примере), но писать, по понятным причинам, можно только в master.</p>

<p>Самый простой способ превратить slave в standalone ноду (например, при миграции БД между серверами) - удалить файл recovery.conf и перезапустить PostgreSQL.</p>

<h1 id="pgbouncer">PgBouncer</h1>

<p>Утилита, созданная для проксирования соединений к PostgreSQL (для каждого соединения по умолчанию создается отдельный процесс). PgBouncer объединяет некоторое количество соединений клиентов в пул и тратит только одно соединение сервера на их обработку.</p>

<p>Базовая конфигурация (без учета требований к безопасности):</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pgbouncer.ini
[databases]
* = host=localhost port=5432
postgres = dbname=postgres
auth_type = trust
admin_users = postgres

[pgbouncer]
listen_addr = *
listen_port = 6432
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>userlist.txt 
"postgres" "postgres"
</code></pre></div></div>


</div>

<div class="post-categories">
  
  
  <b>Categories:</b>
  <a href="/categories/#SQL">SQL</a>
  
  
</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/prom-interfaces-exporter">
            Prometheus interfaces exporter
            <small>01 Apr 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/simple-cd-with-teamcity-docker-ansible">
            Простейший CD с использованием TeamCity, Docker и Ansible
            <small>28 Jan 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/understanding-and-deploying-cisco-sd-wan">
            Understanding and Deploying Cisco SD-WAN (BRKRST-2767)
            <small>28 Dec 2017</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>
    
      </div>
    </div>

  </body>

</html>
