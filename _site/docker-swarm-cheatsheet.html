<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-111661498-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'UA-111661498-1');
  </script>
  
  <!-- Yandex.Metrika counter -->
  <script type="text/javascript" >
      (function (d, w, c) {
          (w[c] = w[c] || []).push(function() {
              try {
                  w.yaCounter45675420 = new Ya.Metrika({
                      id:45675420,
                      clickmap:true,
                      trackLinks:true,
                      accurateTrackBounce:true
                  });
              } catch(e) { }
          });
  
          var n = d.getElementsByTagName("script")[0],
              s = d.createElement("script"),
              f = function () { n.parentNode.insertBefore(s, n); };
          s.type = "text/javascript";
          s.async = true;
          s.src = "https://mc.yandex.ru/metrika/watch.js";
  
          if (w.opera == "[object Opera]") {
              d.addEventListener("DOMContentLoaded", f, false);
          } else { f(); }
      })(document, window, "yandex_metrika_callbacks");
  </script>
  <noscript><div><img src="https://mc.yandex.ru/watch/45675420" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
  <!-- /Yandex.Metrika counter -->

  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Docker Swarm CheatSheet &middot; AboutNet
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p></p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>
    <a class="sidebar-nav-item" href="/categories/">Categories</a> 
    <a class="sidebar-nav-item" href="/about/">About</a>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; <a href="https://jekyllrb.com/">Jekyll</a> & <a href="http://lanyon.getpoole.com/">Lanyon</a>. 2019. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <label for="sidebar-checkbox" class="sidebar-toggle"></label>

          <h3 class="masthead-title">
            <a href="/" title="Home">AboutNet</a>
            <small>all about networks</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Docker Swarm CheatSheet</h1>
  <span class="post-date">03 Oct 2017</span>
    <h2 id="содержание">Содержание</h2>
<ul>
  <li><a href="/docker-swarm-cheatsheet#Установка">Установка</a></li>
  <li><a href="/docker-swarm-cheatsheet#Использование">Использование</a>
    <ul>
      <li><a href="/docker-swarm-cheatsheet#Использование-docker-config">Использование docker config</a></li>
    </ul>
  </li>
</ul>

<h2 id="установка-">Установка <a name="Установка"></a></h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>yum <span class="nb">install</span> <span class="nt">-y</span> yum-utils device-mapper-persistent-data lvm2
<span class="nb">sudo </span>yum-config-manager <span class="nt">--add-repo</span> https://download.docker.com/linux/centos/docker-ce.repo
<span class="nb">sudo </span>yum makecache fast
<span class="nb">sudo </span>yum <span class="nb">install </span>docker-ce <span class="nt">-y</span>

<span class="nb">sudo </span>systemctl <span class="nb">enable </span>docker
<span class="nb">sudo </span>systemctl start docker
</code></pre></div></div>
<!---excerpt-break-->
<h2 id="использование-">Использование <a name="Использование"></a></h2>

<h3 id="инициализация-кластера">Инициализация кластера</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>docker swarm init <span class="nt">--advertise-addr</span> 10.10.10.101
Swarm initialized: current node <span class="o">(</span>siubj077zvc6bbxb9l2alr0up<span class="o">)</span> is now a manager.
To add a worker to this swarm, run the following <span class="nb">command</span>:
   docker swarm <span class="nb">join</span> <span class="nt">--token</span> SWMTKN-1-0lx3v80ql0bqy508rxaqo0x6sseokwzgd9brj902bif0ylbv6y-47on62zw39p154yfeu5ihfs3g 10.10.10.101:2377
To add a manager to this swarm, run <span class="s1">'docker swarm join-token manager'</span> and follow the instructions.

<span class="nb">sudo </span>docker node <span class="nb">ls
</span>ID HOSTNAME STATUS AVAILABILITY MANAGER STATUS
ad3rwed27xksrkhpmlktf4aco vm3.home Ready Active 
ka75127cw1pc1t6gnxm1cffs9 vm2.home Ready Active 
siubj077zvc6bbxb9l2alr0up <span class="k">*</span> vm1.home Ready Active Leader
</code></pre></div></div>
<h4 id="разворачивание-сервиса">Разворачивание сервиса:</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo docker service create --replicas 3 --name helloworld alpine ping docker.com
</code></pre></div></div>
<p>Если параметр replicas больше, чем количество нод в кластере swarm  - на некоторых нодах будет создан более чем один контейнер.</p>
<h4 id="удаление-сервиса">Удаление сервиса:</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo docker service rm helloworld
</code></pre></div></div>
<p>При создании кластера swarm автоматически создается оверлейная vxlan сеть для связи контейнеров внутри нод.</p>
<h4 id="увеличение-количества-запущенных-контейнеров-для-сервиса">Увеличение количества запущенных контейнеров для сервиса:</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo docker service scale helloworld=10
</code></pre></div></div>
<h4 id="информация-о-контейнерах-сервиса">Информация о контейнерах сервиса:</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo docker service ps helloworld
</code></pre></div></div>
<h4 id="перевод-ноды-в-режим-обслуживания-активные-контейнеры-будут-развернуты-на-других-нодах">Перевод ноды в режим обслуживания (активные контейнеры будут развернуты на других нодах):</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo docker node update --availability drain vm2.home
</code></pre></div></div>
<p>Также реплика контейнера будет создана в случае каких-то проблем с нодой (например, ее перезагрузка).</p>
<h4 id="возврат-ноды-из-режима-обслуживания-контейнеры-не-возвращаются-на-ноду-автоматически">Возврат ноды из режима обслуживания (контейнеры не возвращаются на ноду автоматически):</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo docker node update --availability active vm2.home
</code></pre></div></div>
<h4 id="перебалансировка-контейнеров-по-всем-активным-нодам-пересоздает-контейнеры-ведет-к-прерыванию-связи">Перебалансировка контейнеров по всем активным нодам (пересоздает контейнеры, ведет к прерыванию связи):</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo docker service update helloworld --force
</code></pre></div></div>
<h4 id="задание-лимита-на-хранение-выключенных-копий-контейнеров-вида-_helloworld">Задание лимита на хранение выключенных копий контейнеров вида _helloworld:</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo docker swarm update --task-history-limit 1
</code></pre></div></div>
<h3 id="использование-docker-config-">Использование docker config <a name="Использование-docker-config"></a></h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>my.conf 
 server <span class="o">{</span>
    listen 80<span class="p">;</span>
    server_name localhost<span class="p">;</span>

    location / <span class="o">{</span>
        proxy_pass http://127.0.0.1:80/<span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<h4 id="создание-файла-конфигурации">Создание файла конфигурации:</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo docker config create my_nginx_conf my.conf
</code></pre></div></div>
<h4 id="создание-сервиса-с-файлом-конфигурации">Создание сервиса с файлом конфигурации:</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo docker service create --name nginx_with_my_conf --replicas 3 --config source=my_nginx_conf,target=/etc/nginx/conf.d/my.conf nginx
</code></pre></div></div>
<h4 id="проверка-на-одном-из-worker">Проверка на одном из worker:</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>docker <span class="nb">exec</span> <span class="nt">-ti</span> c7317bf582bf <span class="nb">cat</span> /etc/nginx/conf.d/my.conf
 server <span class="o">{</span>
    listen 80<span class="p">;</span>
    server_name localhost<span class="p">;</span>

    location / <span class="o">{</span>
        proxy_pass http://127.0.0.1:80/<span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

</div>

<div class="post-categories">
  
  
  <b>Categories:</b>
  <a href="/categories/#Containers">Containers</a>
  
  
</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/edx-introduction-to-devops">
            edX Introduction to DevOps
            <small>05 Jan 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/prometheus-kubernetes">
            Prometheus and Kubernetes
            <small>02 Jan 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/prom-interfaces-exporter">
            Prometheus interfaces exporter
            <small>01 Apr 2018</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>
    
      </div>
    </div>

  </body>

</html>
